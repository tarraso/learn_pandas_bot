# Generated by Django 5.2 on 2025-11-21 20:12

from django.db import migrations


def copy_relations_to_through_model(apps, schema_editor):
    """Copy existing Question-Dataset M2M relations to QuestionDataset through model"""
    Question = apps.get_model('questions', 'Question')
    QuestionDataset = apps.get_model('questions', 'QuestionDataset')

    for question in Question.objects.all():
        for dataset in question.datasets.all():
            # Create QuestionDataset with empty expected_result as placeholder
            QuestionDataset.objects.create(
                question=question,
                dataset=dataset,
                expected_result={},  # Placeholder - to be filled later
                description='',
                order=0
            )


def restore_m2m_relations(apps, schema_editor):
    """Reverse operation: copy QuestionDataset back to M2M if rolling back"""
    Question = apps.get_model('questions', 'Question')
    QuestionDataset = apps.get_model('questions', 'QuestionDataset')

    for qd in QuestionDataset.objects.all():
        qd.question.datasets.add(qd.dataset)


class Migration(migrations.Migration):

    dependencies = [
        ('questions', '0006_create_question_dataset_model'),
    ]

    operations = [
        migrations.RunPython(copy_relations_to_through_model, restore_m2m_relations),
    ]
